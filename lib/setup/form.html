<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <title>PyonAir Configuration</title>
        <style>
        body{
            background-color: #252525;
            margin-left: 25px;
            margin-top: 30px;
            margin-bottom: 45px;
            font-family: helvetica;
            color: white;
            font-size: 15px;
        }
        .body-light {
            background-color: white;
            color: black;
        }
        h1{
            margin-bottom: 0px;
        }
        p{
            font-size: 20px;
            margin-left: 5px;
            margin-bottom: 0px;
            margin-top: 2em;
        }
        hr {
            display: block;
            height: 1px;
            width: 270px;
            border: 0;
            border-top: 1px solid #909090;
            margin-top: 0.1em;
            margin-left: -5px;
        }
        .p_line{
            padding-bottom: 0.8em;
        }
        form {
            margin-left: 5px;
        }
        label {
            display: block;
            margin-top: 1em;
        }
        .settings{
            margin-left: 30px;
        }
        .lora_grid1{
            display: grid;
            grid-template-columns: 120px 100px;
        }
        .lora_grid2{
            display: grid;
            grid-template-columns: 95px 100px;
        }
        .hardware_test_grid{
            display: grid;
        }
        .pm_sensors{
            margin-left: 15px;
            display: grid;
            grid-template-columns: 390px 110px;
        }
        .pm_sensors .pm_sensor_label{
            margin-top: 1em;
        }
        .pm_sensors hr{
            width: 360px;
        }
        .input_text{
            margin-top: 5px;
            box-sizing: border-box;
            height: 1.8em;
            padding: 2px 4px;
            width: 200px;
        }
        .input_checkbox{
            margin-top: 0.6em;
            margin-left: 5px;
            transform: scale(1.6);
        }
        select{
            margin-top: 5px;
            width: 110px;
            height: 1.8em;
        }
        .sensor{
            display: grid;
            grid-template-columns: 150px 110px 110px 110px;
            margin-left: 10px;
            margin-top: -0.5em;
            margin-bottom: 1.8em;
        }
        .input_number{
            margin-top: 5px;
            box-sizing: border-box;
            height: 1.8em;
            padding: 2px 4px;
            width: 70px;
        }
        .pm_sensors .sensor{
            grid-template-columns: 150px 110px 110px;
            margin-left: -5px;
            margin-bottom: 0;
            margin-top: -1.3em;
        }
        .grid_item3{
            grid-column-start: 2;
            grid-column-end: 3;
            grid-row-start: 1;
            grid-row-end: 4;
            margin-top: 50%;
            margin-left: -5px;
        }
        .sensor_settings{
            width: 530px;
        }
        .interval_hr{
            width: 380px;
        }
        .gps_hr{
            width: 480px;
        }
        .hint{
            margin: 0;
            font-size: 0.8em;
            color: pink;
            display: none;
        }
        .hint-light{
            color: red;
        }
        </style>
    </head>
    <body>
        <h1>PyonAir Configuration</h1>
        <form class="config_form">
        </br>
        <button id="showDescBtn" >Show Guide</button>
        <button id="lightToggleBtn" >Light Theme</button>
        <button type="submit">Save</button>
        
        <p>General Settings</p>
        <hr class="p_line"/>
        <div class="settings">
            
            <label>Unique ID: {unique_id}</label>
            <p class="hint">The randomly generated unique ID of this device</p>
            
            <label for="device_name">Device Name</label>
            <p class="hint">What would you like to name your device? Can be anything</p>
            <input class="input_text" id="device_name" name="device_name" type="text" value="{device_name}" required="required" maxlength="32"/>
            
            <label for="password">New Password</label>
            <p class="hint">Password for OTA updates</p>
            <input class="input_text" id="password" name="password" type="password" value="{password}" required="required" maxlength="32"/>
            
            <label for="config_timeout">Config Timeout (minutes)</label>
            <p class="hint">How long to wait for a new config to be sent from this page</p>
            <input class="input_number" id="config_timeout" name="config_timeout" type="number" value="{config_timeout}" required="required" min="3" max="120" step="0.01"/>
            
        </div>
        <p>LoRaWAN Configuration</p>
        <hr class="p_line"/>
        <div class="settings">
            
            <label>Device EUI: {device_eui}</label>
            <p class="hint">The manufacterer assigned "Extended Unique Identifier"</p>
            
            <label for="application_eui">Application EUI</label>
            <p class="hint">The Extended Unique Identifier assigned to your app by The Things Network</p>
            <input class="input_text" id="application_eui" name="application_eui" type="text" value="{application_eui}" required="required" maxlength="16"/>
            
            <label for="app_key">App Key </label>
            <p class="hint">Your Things Network applications Access Key</p>
            <input class="input_text" id="app_key" name="app_key" type="password" value="{app_key}" required="required" maxlength="32"/>
            
            <div class = "lora_grid1">
                <div>
                    <label for="fair_access">Fair Access (s)</label>
                    <input class="input_number" id="fair_access" name="fair_access" type="number" value="{fair_access}" required="required" min="0" max="65535"/>
                </div>
                <div>
                    <label for="air_time">Air Time (ms)</label>
                    <input class="input_number" id="air_time" name="air_time" type="number" value="{air_time}" required="required" min="0" max="5000"/>
                </div>
            </div>
            <p class="hint">Used to determine LoRa message limit</p>
            <div class = "lora_grid2">
                <div>
                    <label for="LORA">On?</label>
                    <input class="input_checkbox" type="checkbox" name="LORA" value="ON" {lora_check}>
                </div>
                <div>
                    <label for="region">Region</label>
                    <select name="region">
                        <option{eu_selected}>Europe</option>
                        <option{as_selected}>Asia</option>
                        <option{au_selected}>Australia</option>
                        <option{us_selected}>United States</option>
                    </select>
                </div>
            </div>
            </div>
            <p>WiFi Configuration</p>
            <hr class="p_line"/>
            <div class="settings">
                <label for="SSID">SSID</label>
                <p class="hint">The name of the Wi-Fi network to connect to</p>
            <input class="input_text" id="SSID" name="SSID" type="text" value="{SSID}" required="required" maxlength="32"/>
            <label for="wifi_password">Password</label>
            <p class="hint">The password for the given Wi-Fi network</p>
            <input class="input_text" id="wifi_password" name="wifi_password" type="password" value="{wifi_password}" required="required" maxlength="128"/>
        </div>
        <p>Sensor Settings</p>           
        <hr class="p_line sensor_settings"/>
        <p class="hint">Individual sensor settings. Type is the type of the sensor hardware, ID is how the code identifies it</p>
        <div class="settings">
            <label>Temperature and Humidity Sensor</label>
            <hr class="interval_hr"/>
            <div class="sensor">
                <div>
                    <label for="TEMP">Sensor Type</label>
                    <select name="TEMP">
                        <option{temp_selected_SHT35}>SHT35</option>
                        <option{temp_selected_off}>OFF</option>
                    </select>
                </div>
                <div>
                    <label for="TEMP_id">Sensor ID</label>
                    <input class="input_number" id="TEMP_id" name="TEMP_id" type="number" value="{TEMP_id}" required="required" min="0" max="65535"/>
                </div>
                <div>
                    <label for="TEMP_period">Period (s)</label>
                    <input class="input_number" id="TEMP_period" name="TEMP_freq" type="number" value="{TEMP_period}" required="required" min="1" max="120"/>
                </div>
            </div>
            <label>Particulate Matter Sensors</label>
            <hr class="interval_hr"/>
            <div class="pm_sensors">
                <div class="grid_item1">
                    <label class="pm_sensor_label">PM Sensor 1</label>
                    <hr/>
                </div>
                <div class="sensor grid_item2">
                    <div>
                        <label for="PM1">Sensor Type</label>
                        <select name="PM1">
                            <option{PM1_PMS5003_selected}>PMS5003</option>
                            <option{PM1_SPS030_selected}>SPS030</option>
                            <option{PM1_selected_off}>OFF</option>
                        </select>
                    </div>
                    <div>
                        <label for="PM1_id">Sensor ID</label>
                        <input class="input_number" id="PM1_id" name="PM1_id" type="number" value="{PM1_id}" required="required" min="0" max="65535"/>
                    </div>
                    <div>
                    <label for="PM1_init">Setup Time (s)</label>
                    <input class="input_number" id="PM1_init" name="PM1_init" type="number" value="{PM1_init}" required="required" min="1" max="3600" step="0.01"/>
                </div>
                </div>
                <div class="grid_item3">
                    <label for="interval">Interval (m)</label>
                    <input class="input_number" id="PM_interval" name="interval" type="number" value="{interval}" required="required" min="1" max="120" step="0.01"/>
                </div>
                <div class="grid_item4">
                    <label class="pm_sensor_label">PM Sensor 2</label>
                    <hr/>
                </div>
                <div class="sensor grid_item5">
                    <div>
                        <label for="PM2">Sensor Type</label>
                        <select name="PM2">
                            <option{PM2_PMS5003_selected}>PMS5003</option>
                            <option{PM2_SPS030_selected}>SPS030</option>
                            <option{PM2_selected_off}>OFF</option>
                        </select>
                    </div>
                    <div>
                        <label for="PM2_id">Sensor ID</label>
                        <input class="input_number" id="PM2_id" name="PM2_id" type="number" value="{PM2_id}" required="required" min="0" max="65535"/>
                    </div>
                    <div>
                        <label for="PM2_init">Setup Time (s)</label>
                        <input class="input_number" id="PM2_init" name="PM2_init" type="number" value="{PM2_init}" required="required" min="1" max="3600" step="0.01"/>
                    </div>
                </div>
                </div>
                <label>GPS</label>
            <hr class="gps_hr"/>
            <div class="sensor">
                <div>
                    <label for="GPS">Sensor Type</label>
                    <select name="GPS">
                        <option{gps_selected_SIM28}>SIM28</option>
                        <option{gps_selected_off}>OFF</option>
                    </select>
                </div>
                <div>
                    <label for="GPS_id">Sensor ID</label>
                    <input class="input_number" id="GPS_id" name="GPS_id" type="number" value="{GPS_id}" required="required" min="0" max="65535"/>
                </div>
                <div>
                    <label for="GPS_timeout">Timeout (m)</label>
                    <input class="input_number" id="GPS_timeout" name="GPS_timeout" type="number" value="{GPS_timeout}" required="required" min="5" max="120" step="0.01"/>
                </div>
                <div>
                <label for="GPS_period">Period (h)</label>
                <input class="input_number" id="GPS_period" name="GPS_period" type="number" value="{GPS_period}" required="required" min="0.1" max="8760" step="0.01"/>
                </div>
            </div>
        </div>
            <hr class="p_line sensor_settings"/>
            <label for="logging_lvl">Select Logging Level</label>
            <p class="hint">What level of information do you want in your logs</p>
            <select id="logging_lvl" name="logging_lvl">
                <option{logging_level_selected_critical}>Critical</option>
                <option{logging_level_selected_error}>Error</option>
                <option{logging_level_selected_warning}>Warning</option>
                <option{logging_level_selected_info}>Info</option>
                <option{logging_level_selected_debug}>Debug</option>
            </select>
            <div class="hardware_test_grid">
                <div>
                    <label for="hardware_test">Perform hardware test on startup?</label>
                    <p class="hint">Useful if you are experiencing problems, you will need to turn it off afterwards</p>
                    <select name="hardware_test">
                        <option {hardware_test_on}>Yes</option>
                        <option {hardware_test_off}>No</option>
                    </select>
                </div>
            </div>
            <br><br>
            <button type="submit">Save</button>
        </form>
        
        <script>
            
            const hints = document.querySelectorAll(".hint");
        const lightThemeToggleBtn = document.querySelector('#lightToggleBtn');
        
        document.getElementById("showDescBtn").addEventListener('click', () => {
            hints.forEach((e) => {
                e.style.display = "block"; 
            })
        })
        
        lightThemeToggleBtn.addEventListener('click', function() {
            const btnText = lightThemeToggleBtn.innerText
            lightThemeToggleBtn.innerText = btnText == "Dark Theme" ? "Light Theme" : "Dark Theme";
            document.body.classList.toggle('body-light');
            hints.forEach((e) => {
                e.classList.toggle("hint-light"); 
            })
        })
        
        //Source: https://lengstorf.com/get-form-values-as-json/
        
        const isValidElement = element => {
            return element.name && element.value;
        };
        
        const isValidValue = element => {
            return (!['checkbox'].includes(element.type) || element.checked);
        };
        
        const formToJSON = elements => [].reduce.call(elements, (data, element) => {
            
            // Make sure the element has the required properties and should be added.
            if (isValidElement(element) && isValidValue(element)) {
                data[element.name] = element.value;
            }
            return data;
        }, {});
        
        const handleFormSubmit = event => {           
            // Stop the form from submitting since we’re handling that with AJAX.
            event.preventDefault();
            
            // Call our function to get the form data.
            const data = formToJSON(form.elements);
            
            // Use `JSON.stringify()` to make the output valid, human-readable JSON.
            var json_data = "json_str_begin" + JSON.stringify(data, null, "") + "json_str_end";
            
            json_data.replace(/\\n/g, '');
            
            var date = new Date();
            var now = 'time_begin'+date.getUTCFullYear()+':'+(date.getUTCMonth()+1)+':'+date.getUTCDate()+':'+date.getUTCHours()+":"+date.getUTCMinutes()+":"+date.getUTCSeconds()+'time_end';
            
            // Send it off to the device
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "", true);
            xhttp.send(json_data+now);
            
        };
        
        const form = document.getElementsByClassName('config_form')[0];
        form.addEventListener('submit', handleFormSubmit);
        </script>
    </body>
    </html>
